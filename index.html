<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SnipeScan Pro</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --bg: #f8f9fa; --card-bg: #fff; --text: #2c3e50; --primary: #2ecc71; --secondary: #3498db; --danger: #e74c3c; --warning: #f39c12; --border: #ddd; }
        [data-theme="dark"] { --bg: #121212; --card-bg: #1e1e1e; --text: #e0e0e0; --border: #333; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; margin: 0; padding: 10px; padding-bottom: 40px; }
        .card { background: var(--card-bg); padding: 15px; border-radius: 12px; margin-top: 10px; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        #reader { width: 100%; border-radius: 12px; overflow: hidden; background: #000; position: relative; border: 3px solid var(--border); }
        .btn { padding: 14px; border: none; border-radius: 8px; color: #fff; font-weight: bold; width: 100%; margin-top: 8px; cursor: pointer; display: block; text-align: center; text-decoration: none; }
        .scan-item { padding: 10px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        input, select { width: 100%; padding: 12px; margin: 5px 0; border-radius: 8px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text); font-size: 16px; box-sizing: border-box; }
        #info-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:1000; justify-content:center; align-items:center; }
        .modal-content { background:var(--card-bg); padding:20px; width:85%; max-width:400px; border-radius:15px; border-top: 5px solid var(--warning); }
        .info-row { margin-bottom: 8px; border-bottom: 1px solid var(--border); padding-bottom: 4px; }
        .info-label { font-size: 10px; font-weight: bold; color: var(--secondary); text-transform: uppercase; }
        #loading-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; color:#fff; flex-direction:column; justify-content:center; align-items:center; }
    </style>
</head>
<body>

<div id="loading-overlay"><div style="font-weight:bold; font-size:18px;" id="loading-msg">Processing...</div></div>
<div id="info-modal"><div class="modal-content" id="info-body"></div></div>

<div style="display:flex; justify-content:space-between; align-items:center;">
    <h2 style="margin:0;">üì¶ SnipeScan Pro</h2>
    <button onclick="toggleDarkMode()" style="background:none; border:none; font-size:20px;">üåô</button>
</div>

<div id="reader" style="margin-top:10px;"></div>
<div id="status" style="text-align:center; font-size:12px; padding:8px; font-weight:bold; color:var(--secondary);">Ready</div>

<div style="display:flex; gap:8px;">
    <button id="info-btn" class="btn" style="background:var(--warning); color:#000;" onclick="startInfoScan()">üîç Info Scan</button>
    <button class="btn" style="background:var(--secondary)" onclick="toggleSection('manual')">‚å®Ô∏è Manual</button>
</div>

<div id="manual" class="card" style="display:none; border-style:dashed;">
    <input type="text" id="manual-tag" placeholder="Type Asset Tag..." style="text-transform:uppercase;">
    <button class="btn" style="background:var(--secondary)" onclick="addAssetToQueue(document.getElementById('manual-tag').value.toUpperCase())">Add to Queue</button>
</div>

<div class="card">
    <div style="display:flex; justify-content:space-between;">
        <strong>Queue (<span id="count">0</span>)</strong>
        <button onclick="clearBatch()" style="color:var(--danger); border:none; background:none; font-size:11px;">Clear All</button>
    </div>
    <div id="list" style="max-height:150px; overflow-y:auto; margin-top:8px;"></div>
</div>

<div class="card">
    <label style="font-size:11px; font-weight:bold;">TARGET SETTINGS</label>
    <select id="target-type" onchange="loadResources()"><option value="user">Assign to User</option><option value="location" selected>Assign to Location</option></select>
    <input type="text" id="assign-search" placeholder="Filter names..." onkeyup="filterList()">
    <select id="target-id"></select>
    <select id="status-id"></select>
    
    <div id="controls" style="display:none; margin-top:10px; border-top:1px solid var(--border); padding-top:10px;">
        <button class="btn" style="background:var(--primary)" onclick="processBatch('IN')">üì• Check-In All</button>
        <button class="btn" style="background:var(--danger)" onclick="processBatch('OUT')">üì§ Check-Out All</button>
        <button class="btn" style="background:var(--warning); color:#000" onclick="processBatch('AUDIT')">‚öñÔ∏è Official Audit</button>
    </div>
</div>

<script>
    const PROXY_URL = "https://script.google.com/macros/s/AKfycbyAulZX5dQD8cqSqsNK9RyhPDzvaRe5OR4-T6p7xz81HOZgv8H_TmI1FWI-Nf4OboDg-A/exec"; // REPLACE THIS!
    let queue = [], users = [], locations = [], labels = [], infoMode = false, isLocked = false;

    const scanner = new Html5Qrcode("reader");
    scanner.start({ facingMode: "environment" }, { fps: 15, qrbox: {width: 250, height: 150} }, (tag) => {
        if (isLocked) return;
        const clean = tag.trim().toUpperCase();
        if (infoMode) return fetchInfo(clean);
        if (!queue.some(i => i.tag === clean)) addAssetToQueue(clean);
    });

    async function addAssetToQueue(tag) {
        isLocked = true;
        const res = await proxyRequest(`/hardware/bytag/${tag}`);
        const asset = res.id ? res : res.rows?.[0];
        if (asset) {
            queue.unshift({ id: asset.id, tag: tag, name: asset.model.name });
            updateUI();
        }
        setTimeout(() => { isLocked = false; }, 1500);
    }

    async function fetchInfo(tag) {
        isLocked = true; infoMode = false;
        document.getElementById('status').innerText = 'Searching...';
        const res = await proxyRequest(`/hardware/bytag/${tag}`);
        const a = res.id ? res : res.rows?.[0];
        if (!a) { alert("Asset not found"); isLocked = false; return; }
        
        const rows = [["Tag", a.asset_tag], ["Model", a.model.name], ["Serial", a.serial], ["Status", a.status_label.name], ["Assigned", a.assigned_to?.name || 'Unassigned']];
        document.getElementById('info-body').innerHTML = `<h3>Asset Info</h3>` + rows.map(r => `<div class="info-row"><div class="info-label">${r[0]}</div><div>${r[1] || 'N/A'}</div></div>`).join('') + `<button class="btn" style="background:var(--secondary)" onclick="closeModal()">Close</button>`;
        document.getElementById('info-modal').style.display = 'flex';
        document.getElementById('status').innerText = 'Ready';
    }

    async function processBatch(type) {
        if (!queue.length) return;
        showLoading(`Processing ${type}...`);
        
        const targetId = document.getElementById('target-id').value;
        const statusId = document.getElementById('status-id').value;
        const targetName = document.getElementById('target-id').options[document.getElementById('target-id').selectedIndex].text;
        
        const nextAudit = new Date(); nextAudit.setFullYear(nextAudit.getFullYear() + 1);
        const auditDate = nextAudit.toISOString().split('T')[0];

        try {
            for (let item of queue) {
                let ep, p = {};
                if (type === 'AUDIT') { 
                    ep = `/hardware/${item.id}/audit`; 
                    p = { asset_tag: item.tag, location_id: targetId, next_audit_date: auditDate, note: "Scanner Audit" }; 
                }
                if (type === 'OUT') { 
                    ep = `/hardware/${item.id}/checkout`; 
                    p = { checkout_to_type: document.getElementById('target-type').value, assigned_location: targetId, assigned_user: targetId, status_id: statusId }; 
                }
                if (type === 'IN') { 
                    ep = `/hardware/${item.id}/checkin`; 
                    p = { status_id: statusId }; 
                }
                await proxyRequest(ep, "POST", p);
            }

            await proxyRequest('email-log', "POST", { action: type, count: queue.length, details: queue.map(i => `${i.tag} | ${i.name} ‚ûî ${targetName}`) });
            
            alert(`Success! ${type} complete for ${queue.length} items.`);
            queue = []; updateUI();
        } catch (e) { alert("Error: " + e); } finally { hideLoading(); }
    }

    async function proxyRequest(endpoint, method = "GET", payload = null) {
    try {
        const res = await fetch(PROXY_URL, { 
            method: 'POST', 
            mode: 'cors', // Force CORS mode
            body: JSON.stringify({ endpoint, method, payload }) 
        });
        
        if (!res.ok) throw new Error(`Network Error: ${res.status}`);
        
        const data = await res.json();
        console.log("Server Response:", data);
        return data;
    } catch (e) {
        console.error("Fetch failed:", e);
        alert("Connection Failed: Check if PROXY_URL is correct and Deployed as 'Anyone'.");
        throw e;
    }
}

    function updateUI() {
        document.getElementById('count').innerText = queue.length;
        document.getElementById('list').innerHTML = queue.map((i, idx) => `<div class="scan-item"><div><b>${i.tag}</b><br><small>${i.name}</small></div><button onclick="queue.splice(${idx},1);updateUI();" style="color:var(--danger); border:none; background:none; font-size:20px;">&times;</button></div>`).join('');
        document.getElementById('controls').style.display = queue.length ? 'block' : 'none';
    }

    function startInfoScan() { infoMode = true; document.getElementById('status').innerText = 'INFO MODE ACTIVE'; document.getElementById('info-btn').style.background = "var(--primary)"; }
    function closeModal() { document.getElementById('info-modal').style.display = 'none'; isLocked = false; document.getElementById('info-btn').style.background = "var(--warning)"; }
    function showLoading(m) { document.getElementById('loading-msg').innerText = m; document.getElementById('loading-overlay').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loading-overlay').style.display = 'none'; }
    function toggleSection(id) { const el = document.getElementById(id); el.style.display = el.style.display === 'none' ? 'block' : 'none'; }
    function toggleDarkMode() { document.documentElement.setAttribute("data-theme", document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark"); }

    async function init() {
        const [u, l, s] = await Promise.all([proxyRequest('/users?limit=500'), proxyRequest('/locations?limit=500'), proxyRequest('/statuslabels')]);
        users = u.rows; locations = l.rows; labels = s.rows;
        loadResources();
        document.getElementById('status-id').innerHTML = labels.map(i => `<option value="${i.id}">${i.name}</option>`).join('');
    }

    function loadResources() {
        const data = document.getElementById('target-type').value === 'user' ? users : locations;
        document.getElementById('target-id').innerHTML = data.map(i => `<option value="${i.id}">${i.name || i.display_name}</option>`).join('');
    }

    function filterList() {
        const q = document.getElementById('assign-search').value.toLowerCase();
        const data = document.getElementById('target-type').value === 'user' ? users : locations;
        const filtered = data.filter(i => (i.name || i.display_name).toLowerCase().includes(q));
        document.getElementById('target-id').innerHTML = filtered.map(i => `<option value="${i.id}">${i.name || i.display_name}</option>`).join('');
    }

    function clearBatch() { queue = []; updateUI(); }

    init();
</script>
</body>
</html>
